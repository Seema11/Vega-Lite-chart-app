<html>
  <head>
    <title>Embedding Vega-Lite</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.20.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.17.0"></script>
  </head>
  <body>
    <div id="vis"></div>

    <script type="text/javascript">

    fetch('https://run.mocky.io/v3/fffa9dda-fe2d-4fdd-9106-258fde7643b3')
    .then(response => response.json())
    .then((response) => {

        // console.log(response);

        let weekArray = [];

        response.forEach(element => {
            let stage = element.Stage.trim();
            let weeksActive = element["Weeks active"];
            
            weeksActive = weeksActive.split(",");
    
            weeksActive.forEach((week) => {
                if(week) {
                    weekArray.push({
                        stage: stage,
                        week : week.trim()
                    })
                }
            })
        });


        let weekObject = {};

        for(i=0; i<55; i++) {
            weekObject[i] = {
                
            }
        }

        weekArray.forEach((item) => {
            let week = item.week;
            let stage = item.stage;

            if(!weekObject[week][stage]) {
                weekObject[week] = {
                    [stage] : 1
                }
            } else {
                weekObject[week][stage] = weekObject[week][stage] + 1;
            }

        })

        let data = [];

        for(i=0; i<55; i++) {
            let stage = Object.keys(weekObject[i])[0];
            let count = weekObject[i][stage];
            if(!count) {
                count = 0;
            }

            if(stage) {
                data.push({
                    week : i,
                    stage: stage,
                    count: count
                })
            }

        }
        console.log("chart data");
        console.log(data);

        var yourVlSpec = {
        "width": 700,
        "height": 700,   
        "description": "Stock prices of 5 Tech Companies over Time.",
        "data": {
            values : data
        },
        "mark": "line",
        "encoding": {
            "x": {"field": "week", "type": "quantitative"},
            "y": {"field": "count", "type": "quantitative"},
            "color": {"field": "stage", "type": "nominal"}
        }
        };
      vegaEmbed('#vis', yourVlSpec);

    })
    

    </script>
  </body>
</html>